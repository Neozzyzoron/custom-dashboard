<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Widget Viewer</title>
    <style>
        :root {
            --bg-color: #FFFFFF;
            --text-color: #37352F;
            --accent-color: #E3E2E0;
            --bar-fill: #37352F;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #191919;
                --text-color: #D4D4D4;
                --accent-color: #2F2F2F;
                --bar-fill: #D4D4D4;
            }
        }
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 20px; box-sizing: border-box;
        }
        #dashboard { display: flex; flex-direction: column; gap: 24px; max-width: 600px; margin: 0 auto; }
        
        /* Styles */
        .widget-header { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; margin-bottom: 8px; font-weight: 600; }
        .clock-row { display: flex; justify-content: space-between; align-items: baseline; border-bottom: 1px solid var(--accent-color); padding: 8px 0; }
        .clock-row:last-child { border-bottom: none; }
        .clock-label { font-weight: 500; }
        .clock-time { font-family: "SF Mono", "Monaco", monospace; font-weight: 700; }
        .progress-wrapper { margin-bottom: 12px; }
        .progress-meta { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; font-weight: 500; }
        .progress-bg { height: 10px; background-color: var(--accent-color); border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: var(--bar-fill); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .error { color: #eb5757; background: rgba(235, 87, 87, 0.1); padding: 10px; border-radius: 5px; text-align: center;}
    </style>
</head>
<body>
    <div id="dashboard"></div>

    <script>
        // --- 1. URL DECODER ---
        function getConfigFromUrl() {
            try {
                // We look for everything after the '#'
                const hash = window.location.hash.substring(1); 
                if (!hash) return null;
                // Decode from Base64
                return JSON.parse(atob(hash));
            } catch (e) {
                return null;
            }
        }

        // --- 2. RENDERER ---
        const container = document.getElementById('dashboard');

        function render() {
            const config = getConfigFromUrl();
            
            if (!config) {
                container.innerHTML = `<div class="error">
                    <strong>No Settings Found</strong><br>
                    Please use admin.html to generate a configuration link.
                </div>`;
                return;
            }

            container.innerHTML = '';
            config.forEach(widget => {
                if (widget.type === 'header') renderHeader(widget);
                else if (widget.type === 'world_clock') renderWorldClock(widget);
                else if (widget.type === 'progress_group') renderProgressGroup(widget);
                else if (widget.type === 'progress_custom') renderCustomBar(widget);
            });
        }

        function renderHeader(data) {
            const el = document.createElement('div');
            el.className = 'widget-header';
            el.innerText = data.text;
            container.appendChild(el);
        }

        function renderWorldClock(data) {
            const box = document.createElement('div');
            const now = new Date();
            data.locations.forEach(loc => {
                const row = document.createElement('div');
                row.className = 'clock-row';
                let timeStr;
                const options = { hour: '2-digit', minute: '2-digit' };
                if (loc.timezone && loc.timezone !== 'local') options.timeZone = loc.timezone;
                timeStr = now.toLocaleTimeString([], options);
                row.innerHTML = `<span class="clock-label">${loc.label}</span><span class="clock-time">${timeStr}</span>`;
                box.appendChild(row);
            });
            container.appendChild(box);
        }

        function renderProgressGroup(data) {
            const box = document.createElement('div');
            data.items.forEach(item => {
                const dates = getDatesForType(item.type);
                if(dates) box.appendChild(createBarElement(item.label, dates.start, dates.end));
            });
            container.appendChild(box);
        }

        function renderCustomBar(data) {
            container.appendChild(createBarElement(data.label, new Date(data.start), new Date(data.end)));
        }

        function createBarElement(label, start, end) {
            const now = new Date();
            let percent = 0;
            if (now > end) percent = 100;
            else if (now > start) percent = ((now - start) / (end - start)) * 100;

            const wrapper = document.createElement('div');
            wrapper.className = 'progress-wrapper';
            wrapper.innerHTML = `
                <div class="progress-meta"><span>${label}</span><span>${percent.toFixed(1)}%</span></div>
                <div class="progress-bg"><div class="progress-fill" style="width: ${percent}%"></div></div>
            `;
            return wrapper;
        }

        // --- 3. TEMPORAL LOGIC (UPDATED WITH QUARTER/MONTH) ---
        function getDatesForType(type) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            if (type === 'day') {
                return { start: new Date(year, month, now.getDate()), end: new Date(year, month, now.getDate(), 23, 59, 59) };
            }
            if (type === 'week') {
                const day = now.getDay();
                const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
                const start = new Date(now.setDate(diff)); start.setHours(0,0,0,0);
                const end = new Date(start); end.setDate(start.getDate() + 7);
                return { start, end };
            }
            if (type === 'month') {
                return { start: new Date(year, month, 1), end: new Date(year, month + 1, 0) };
            }
            if (type === 'quarter') {
                const quarter = Math.floor(month / 3);
                return { start: new Date(year, quarter * 3, 1), end: new Date(year, (quarter + 1) * 3, 1) };
            }
            if (type === 'year') {
                return { start: new Date(year, 0, 1), end: new Date(year + 1, 0, 1) };
            }
            return null;
        }

        render();
        setInterval(render, 30000); // Update every 30s
    </script>
</body>
</html>
