<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Widget Viewer</title>
    <style>
        :root {
            --bg-color: #FFFFFF;
            --text-color: #37352F;
            --accent-color: #E3E2E0;
            --bar-fill: #37352F;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            --base-size: 16px; /* Configurable */
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #191919;
                --text-color: #D4D4D4;
                --accent-color: #2F2F2F;
                --bar-fill: #D4D4D4;
            }
        }
        
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 1.25rem; 
            box-sizing: border-box;
            font-size: var(--base-size);
        }
        #dashboard { display: flex; flex-direction: column; gap: 1.5rem; max-width: 600px; margin: 0 auto; }
        
        /* --- THEMES --- */
        /* Standard: Clean, Notion-like */
        
        /* Card: Adds borders */
        .theme-card .widget-block {
            border: 1px solid var(--accent-color);
            padding: 1rem;
            border-radius: 8px;
        }

        /* Minimal: Thinner weights, smaller margins */
        .theme-minimal .clock-time { font-weight: 400 !important; }
        .theme-minimal .progress-bg { height: 4px !important; }

        /* --- STYLES --- */
        .widget-header { 
            font-size: 0.75em; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            opacity: 0.6; 
            margin-bottom: 0.5rem; 
            font-weight: 600; 
        }

        .clock-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: baseline; 
            border-bottom: 1px solid var(--accent-color); 
            padding: 0.5rem 0; 
        }
        .clock-row:last-child { border-bottom: none; }
        .clock-label { font-weight: 500; }
        .clock-time { font-family: "SF Mono", "Monaco", monospace; font-weight: 700; }

        .progress-wrapper { margin-bottom: 0.75rem; }
        .progress-meta { 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.85em; 
            margin-bottom: 0.25rem; 
            font-weight: 500; 
        }
        .progress-bg { 
            height: 10px; 
            background-color: var(--accent-color); 
            border-radius: 5px; 
            overflow: hidden; 
        }
        .progress-fill { 
            height: 100%; 
            background-color: var(--bar-fill); 
            width: 0%; 
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .error { color: #eb5757; font-size: 0.9em; text-align: center; padding: 20px;}
    </style>
</head>
<body>
    <div id="dashboard"></div>

    <script>
        // --- 1. CONFIG PARSER ---
        function getConfig() {
            try {
                const hash = window.location.hash.substring(1); 
                if (!hash) return null;
                const data = JSON.parse(atob(hash));
                
                // Backwards compatibility: if data is just an array, wrap it
                if (Array.isArray(data)) return { settings: {}, blocks: data };
                return data;
            } catch (e) { return null; }
        }

        // --- 2. RENDERER ---
        const container = document.getElementById('dashboard');

        function render() {
            const data = getConfig();
            if (!data) {
                container.innerHTML = `<div class="error">No settings found.<br>Use admin.html to generate a link.</div>`;
                return;
            }

            // Apply Global Settings
            const settings = data.settings || {};
            
            // 1. Theme
            document.body.className = `theme-${settings.theme || 'standard'}`;
            
            // 2. Font Size
            if(settings.fontSize === 'small') document.documentElement.style.setProperty('--base-size', '14px');
            if(settings.fontSize === 'large') document.documentElement.style.setProperty('--base-size', '18px');

            container.innerHTML = '';
            
            // Render Blocks
            data.blocks.forEach(block => {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'widget-block'; // wrapper for themes

                if (block.type === 'header') renderHeader(block, blockDiv);
                else if (block.type === 'world_clock') renderWorldClock(block, blockDiv, settings); // Pass settings!
                else if (block.type === 'progress_group') renderProgressGroup(block, blockDiv);
                else if (block.type === 'progress_custom') renderCustomBar(block, blockDiv);
                
                container.appendChild(blockDiv);
            });
        }

        function renderHeader(data, parent) {
            const el = document.createElement('div');
            el.className = 'widget-header';
            el.innerText = data.text;
            parent.appendChild(el);
        }

        function renderWorldClock(data, parent, settings) {
            const now = new Date();
            const use24h = settings.use24h === true;

            data.locations.forEach(loc => {
                const row = document.createElement('div');
                row.className = 'clock-row';
                
                let timeStr;
