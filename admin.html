<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Widget Admin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background: #f4f4f4; color: #333; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { margin-top: 0; font-size: 1.5rem;}
        h2 { font-size: 1.1rem; margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Dragging Styles */
        .block-card { 
            background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; 
            border-left: 6px solid #999; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .block-card.dragging { opacity: 0.5; border: 2px dashed #666; }
        .drag-handle { cursor: grab; padding: 5px 10px; font-size: 1.2rem; color: #aaa; user-select: none; }
        .drag-handle:hover { color: #333; }

        /* Block Card Colors */
        .block-card.type-header         { border-left-color: #bdc3c7; } /* Grey */
        .block-card.type-world_clock    { border-left-color: #1abc9c; } /* Teal */
        .block-card.type-progress_group { border-left-color: #e67e22; } /* Orange */
        .block-card.type-progress_custom{ border-left-color: #f1c40f; } /* Gold */
        .block-card.type-progress_cycle { border-left-color: #9b59b6; } /* Purple */
        .block-card.type-countdown      { border-left-color: #3498db; } /* Blue */
        .block-card.type-timer          { border-left-color: #e74c3c; } /* Red */

        .block-header { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        .block-type { font-weight: bold; text-transform: uppercase; font-size: 0.8rem; color: #666; background: #eee; padding: 3px 6px; border-radius: 4px; flex-grow: 1; }
        
        /* Form Elements */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.85rem; color: #555;}
        input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; box-sizing: border-box;}
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }

        /* Buttons */
        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;}
        button { padding: 10px 16px; cursor: pointer; border: none; border-radius: 6px; font-weight: 600; font-size: 0.9rem; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(1px); }

        /* Colored Buttons */
        .btn-header { background: #eaeded; color: #555; border: 1px solid #bdc3c7; }        
        .btn-time   { background: #d1f2eb; color: #0e6251; border: 1px solid #a2d9ce; }     
        .btn-auto   { background: #fdebd0; color: #935116; border: 1px solid #f5cba7; }     
        .btn-custom { background: #fcf3cf; color: #7d6608; border: 1px solid #f9e79f; }     
        .btn-cycle  { background: #ebdef0; color: #5b2c6f; border: 1px solid #d2b4de; }     
        .btn-count  { background: #d6eaf8; color: #154360; border: 1px solid #a9cce3; }     
        .btn-timer  { background: #fadbd8; color: #78281f; border: 1px solid #e6b0aa; }     
        
        .btn-rem { background: transparent; color: #c0392b; border: 1px solid #c0392b; padding: 4px 10px; font-size: 0.75rem; }
        .btn-gen { background: #27ae60; color: white; width: 100%; font-size: 1rem; padding: 12px; margin-top: 10px; transition: background 0.2s;}

        .output-box { margin-top: 30px; background: #2c3e50; color: white; padding: 20px; border-radius: 8px; }
        code { word-break: break-all; display: block; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9rem;}
    </style>
</head>
<body>

<div class="container">
    <h1>Notion Widget Admin</h1>

    <h2>1. Visual Settings</h2>
    <div class="settings-grid">
        <div><label>Time</label><select id="set-time" onchange="updateSettings()"><option value="12">12 Hour</option><option value="24">24 Hour</option></select></div>
        <div><label>Theme</label><select id="set-theme" onchange="updateSettings()"><option value="standard">Standard</option><option value="minimal">Minimal</option><option value="card">Cards</option></select></div>
        <div><label>Font</label><select id="set-font" onchange="updateSettings()"><option value="standard">Standard</option><option value="small">Small</option><option value="large">Large</option></select></div>
    </div>

    <h2>2. Widget Blocks (Drag ☰ to reorder)</h2>
    <div id="blocks-area"></div>

    <div class="btn-row">
        <button class="btn-header" onclick="addBlock('header')">+ Text</button>
        <button class="btn-time" onclick="addBlock('world_clock')">+ Time</button>
        <button class="btn-auto" onclick="addBlock('progress_group')">+ Progress (Auto)</button>
        <button class="btn-custom" onclick="addBlock('progress_custom')">+ Progress (Custom)</button>
        <button class="btn-cycle" onclick="addBlock('progress_cycle')">+ Recurring Cycle</button>
        <button class="btn-count" onclick="addBlock('countdown')">+ Countdown</button>
        <button class="btn-timer" onclick="addBlock('timer')">+ Timer</button>
    </div>

    <div class="output-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0">3. Your Link</h3>
            <button onclick="preview()" style="background:white; color:#333; padding: 5px 10px; font-size:0.8rem;">Open Preview</button>
        </div>
        <code id="result-url">...</code>
        <button id="gen-btn" class="btn-gen" onclick="generateLink(true)">UPDATE LINK</button>
    </div>
</div>

<script>
    let settings = { use24h: false, theme: 'standard', fontSize: 'standard' };
    let blocks = [];

    // --- INITIALIZATION ---
    function init() {
        try {
            const hash = window.location.hash.substring(1);
            if(hash) {
                const data = JSON.parse(atob(hash));
                if(data.settings) {
                    settings = data.settings;
                    document.getElementById('set-time').value = settings.use24h ? '24' : '12';
                    document.getElementById('set-theme').value = settings.theme;
                    document.getElementById('set-font').value = settings.fontSize;
                }
                if(data.blocks) blocks = data.blocks;
            } else {
                blocks = [{ type: 'header', text: 'New Dashboard' }];
            }
        } catch(e) { console.log('New Load'); }

        renderBlocks();
        generateLink(false);
    }

    // --- RENDERER ---
    function renderBlocks() {
        const area = document.getElementById('blocks-area');
        area.innerHTML = '';

        blocks.forEach((block, index) => {
            const div = document.createElement('div');
            div.className = `block-card type-${block.type}`;
            div.draggable = true;
            div.dataset.index = index;

            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragenter', handleDragEnter);
            div.addEventListener('dragleave', handleDragLeave);
            
            let displayType = block.type.toUpperCase().replace('_', ' ');
            if(block.type === 'world_clock') displayType = "TIME / CLOCKS";
            if(block.type === 'progress_group') displayType = "AUTO PROGRESS";
            
            let html = `<div class="block-header">
                <span class="drag-handle">☰</span>
                <span class="block-type">${displayType}</span> 
                <button class="btn-rem" onclick="removeBlock(${index})">DELETE</button>
            </div>`;
            
            if (block.type === 'header') html += `<label>Text</label><input type="text" value="${block.text}" oninput="updateBlock(${index}, 'text', this.value)">`;
            else if (block.type === 'world_clock') html += `<label>Locations (JSON)</label><textarea rows="3" onchange="updateBlockJSON(${index}, 'locations', this.value)">${JSON.stringify(block.locations)}</textarea>`;
            else if (block.type === 'progress_group') html += `<label>Items (JSON)</label><textarea rows="3" onchange="updateBlockJSON(${index}, 'items', this.value)">${JSON.stringify(block.items)}</textarea>`;
            else if (block.type === 'progress_custom') html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Start</label><input type="date" value="${block.start}" oninput="updateBlock(${index}, 'start', this.value)"></div><div class="col"><label>End</label><input type="date" value="${block.end}" oninput="updateBlock(${index}, 'end', this.value)"></div></div>`;
            else if (block.type === 'progress_cycle') html += `<label>Cycle Name</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Anchor Date</label><input type="date" value="${block.anchor}" oninput="updateBlock(${index}, 'anchor', this.value)"></div><div class="col"><label>Length (Days)</label><input type="number" value="${block.days}" oninput="updateBlock(${index}, 'days', this.value)"></div></div>`;
            else if (block.type === 'countdown') html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Date</label><input type="date" value="${block.date}" oninput="updateBlock(${index}, 'date', this.value)"></div><div class="col"><label>Style</label><select onchange="updateBlock(${index}, 'style', this.value)"><option value="detailed" ${block.style=='detailed'?'selected':''}>Detailed</option><option value="days" ${block.style=='days'?'selected':''}>Days Only</option></select></div></div>`;
            
            // --- UPDATED TIMER BLOCK ---
            else if (block.type === 'timer') {
                html += `<label>Timer Name</label><input type="text" value="${block.label || 'Timer'}" oninput="updateBlock(${index}, 'label', this.value)">`;
                html += `<div class="row">
                    <div class="col"><label>Hours</label><input type="number" min="0" value="${block.hours || 0}" oninput="updateBlock(${index}, 'hours', this.value)"></div>
                    <div class="col"><label>Minutes</label><input type="number" min="0" value="${block.minutes || 0}" oninput="updateBlock(${index}, 'minutes', this.value)"></div>
                </div>`;
            }

            div.innerHTML = html;
            area.appendChild(div);
        });
    }

    // --- DRAG & DROP ---
    let dragSrcEl = null;
    function handleDragStart(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); this.classList.add('dragging'); }
    function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
    function handleDragEnter(e) { this.classList.add('over'); }
    function handleDragLeave(e) { this.classList.remove('over'); }
    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        const srcIndex = parseInt(dragSrcEl.dataset.index);
        const targetIndex = parseInt(this.dataset.index);
        if (dragSrcEl !== this) {
            const item = blocks[srcIndex];
            blocks.splice(srcIndex, 1);
            blocks.splice(targetIndex, 0, item);
            renderBlocks();
            generateLink(false);
        }
        return false;
    }

    // --- ACTIONS ---
    window.addBlock = (type) => {
        let newBlock = { type: type };
        if(type === 'header') newBlock.text = 'New Header';
        if(type === 'world_clock') newBlock.locations = [{label:'NY', timezone:'America/New_York'}];
        if(type === 'progress_group') newBlock.items = [{type:'month', label:'Month'}];
        if(type === 'progress_custom') { newBlock.label = 'Project'; newBlock.start = new Date().toISOString().split('T')[0]; newBlock.end = '2025-12-31'; }
        if(type === 'countdown') { newBlock.label = 'Event'; newBlock.date = '2025-01-01'; newBlock.style = 'detailed'; }
        if(type === 'progress_cycle') { newBlock.label = 'Cycle'; newBlock.anchor = '2024-01-01'; newBlock.days = '30'; }
        
        // UPDATED TIMER DEFAULT
        if(type === 'timer') { newBlock.label = 'Focus'; newBlock.hours = 0; newBlock.minutes = 25; }

        blocks.push(newBlock); renderBlocks(); generateLink(false);
    };

    window.removeBlock = (idx) => { blocks.splice(idx, 1); renderBlocks(); generateLink(false); };
    window.updateBlock = (idx, key, val) => { blocks[idx][key] = val; generateLink(false); };
    window.updateBlockJSON = (idx, key, val) => { try { blocks[idx][key] = JSON.parse(val); generateLink(false); } catch(e){} };
    
    window.updateSettings = () => { 
        settings.use24h = document.getElementById('set-time').value === '24'; 
        settings.theme = document.getElementById('set-theme').value; 
        settings.fontSize = document.getElementById('set-font').value; 
        generateLink(false); 
    };

    window.generateLink = (flashButton) => {
        try {
            const fullConfig = { settings: settings, blocks: blocks };
            const jsonString = JSON.stringify(fullConfig);
            const encoded = btoa(jsonString);
            
            let url = window.location.href.split('#')[0].split('?')[0];
            if (url.includes('admin.html')) url = url.replace('admin.html', 'index.html');
            else if (url.endsWith('/')) url += 'index.html';
            else if (!url.endsWith('index.html')) url += '/index.html';

            const finalUrl = `${url}#${encoded}`;
            document.getElementById('result-url').innerText = finalUrl;
            
            if(flashButton) {
                const btn = document.getElementById('gen-btn');
                const originalText = btn.innerText;
                btn.innerText = "LINK UPDATED!";
                btn.style.background = "#2ecc71";
                setTimeout(() => { btn.innerText = originalText; btn.style.background = "#27ae60"; }, 1000);
            }

            return finalUrl;
        } catch (e) {
            console.error(e);
            alert("Error generating link.");
        }
    };

    window.preview = () => { window.open(generateLink(false), '_blank'); };

    init();
</script>
</body>
</html>
