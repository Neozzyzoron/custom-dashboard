<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Widget Builder - Final</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background: #f4f4f4; color: #333; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        h1 { margin-top: 0; font-size: 1.5rem;}
        h2 { font-size: 1.1rem; margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Settings Grid */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        
        /* Block Cards */
        .block-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #999; }
        .block-card.type-countdown { border-left-color: #3498db; }
        .block-card.type-timer { border-left-color: #e74c3c; }
        
        .block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .block-type { font-weight: bold; text-transform: uppercase; font-size: 0.8rem; color: #666; background: #eee; padding: 3px 6px; border-radius: 4px; }
        
        /* Inputs */
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.85rem; color: #555;}
        input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; box-sizing: border-box;}
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }

        /* Buttons */
        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;}
        button { padding: 10px 16px; cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        
        .btn-add { background: #e3e2e0; color: #333; border: 1px solid #ccc; }
        .btn-add:hover { background: #dcdbdb; }

        /* Highlight specific buttons */
        .btn-count { background: #d4e6f1; color: #154360; border: 1px solid #a9cce3; } /* Blueish */
        .btn-timer { background: #fadbd8; color: #78281f; border: 1px solid #e6b0aa; } /* Redish */

        .btn-rem { background: transparent; color: #c0392b; border: 1px solid #c0392b; padding: 4px 10px; font-size: 0.75rem; }
        .btn-gen { background: #27ae60; color: white; width: 100%; font-size: 1rem; padding: 12px; margin-top: 10px;}

        /* Output */
        .output-box { margin-top: 30px; background: #2c3e50; color: white; padding: 20px; border-radius: 8px; }
        code { word-break: break-all; display: block; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9rem;}
    </style>
</head>
<body>

<div class="container">
    <h1>Notion Widget Admin</h1>
    <p style="color:#666; font-size: 0.9rem;">Configure your blocks below, then generate your custom link.</p>

    <h2>1. Visual Settings</h2>
    <div class="settings-grid">
        <div>
            <label>Time Format</label>
            <select id="set-time" onchange="updateSettings()">
                <option value="12">12 Hour (2:30 PM)</option>
                <option value="24">24 Hour (14:30)</option>
            </select>
        </div>
        <div>
            <label>Theme</label>
            <select id="set-theme" onchange="updateSettings()">
                <option value="standard">Standard</option>
                <option value="minimal">Minimal</option>
                <option value="card">Cards (Bordered)</option>
            </select>
        </div>
        <div>
            <label>Font Size</label>
            <select id="set-font" onchange="updateSettings()">
                <option value="standard">Standard</option>
                <option value="small">Small (Compact)</option>
                <option value="large">Large (Hero)</option>
            </select>
        </div>
    </div>

    <h2>2. Widget Blocks</h2>
    <div id="blocks-area">
        </div>

    <div class="btn-row">
        <button class="btn-add" onclick="addBlock('header')">+ Text Header</button>
        <button class="btn-add" onclick="addBlock('world_clock')">+ World Clocks</button>
        <button class="btn-add" onclick="addBlock('progress_group')">+ Auto Progress</button>
        <button class="btn-add" onclick="addBlock('progress_custom')">+ Life/Project</button>
        
        <button class="btn-count" onclick="addBlock('countdown')">+ Countdown</button>
        <button class="btn-timer" onclick="addBlock('timer')">+ Focus Timer</button>
    </div>

    <div class="output-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0">3. Your Link</h3>
            <button onclick="preview()" style="background:white; color:#333; padding: 5px 10px; font-size:0.8rem;">Open Preview</button>
        </div>
        <p style="opacity: 0.8; font-size: 0.85rem; margin-top:5px;">Copy this link into Notion as an <strong>/embed</strong></p>
        <code id="result-url">Add blocks to generate link...</code>
        <button class="btn-gen" onclick="generateLink()">UPDATE LINK</button>
    </div>
</div>

<script>
    // --- STATE ---
    let settings = { use24h: false, theme: 'standard', fontSize: 'standard' };
    
    // Default blocks to show on first load
    let blocks = [
        { type: 'header', text: 'My Dashboard' },
        { type: 'countdown', label: 'Vacation', date: '2025-12-25', style: 'detailed' }
    ];

    // --- INITIALIZATION ---
    function init() {
        renderBlocks();
        generateLink();
    }

    // --- RENDER LOGIC ---
    function renderBlocks() {
        const area = document.getElementById('blocks-area');
        area.innerHTML = '';

        blocks.forEach((block, index) => {
            const div = document.createElement('div');
            div.className = `block-card type-${block.type}`; // Add class for styling
            
            // Header Row
            let html = `<div class="block-header">
                <span class="block-type">${block.type.toUpperCase().replace('_', ' ')}</span> 
                <button class="btn-rem" onclick="removeBlock(${index})">DELETE</button>
            </div>`;
            
            // Input Fields based on Type
            if (block.type === 'header') {
                html += `<label>Header Text</label>
                         <input type="text" value="${block.text}" oninput="updateBlock(${index}, 'text', this.value)">`;
            } 
            else if (block.type === 'world_clock') {
                html += `<label>Locations (JSON Array)</label>
                         <textarea rows="3" onchange="updateBlockJSON(${index}, 'locations', this.value)">${JSON.stringify(block.locations)}</textarea>
                         <small style="color:#888">Example: [{"label":"NY","timezone":"America/New_York"}]</small>`;
            }
            else if (block.type === 'progress_group') {
                html += `<label>Items (JSON Array)</label>
                         <textarea rows="3" onchange="updateBlockJSON(${index}, 'items', this.value)">${JSON.stringify(block.items)}</textarea>
                         <small style="color:#888">Types: day, week, month, quarter, year</small>`;
            }
            else if (block.type === 'progress_custom') {
                html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)">`;
                html += `<div class="row">
                            <div class="col"><label>Start Date</label><input type="date" value="${block.start}" oninput="updateBlock(${index}, 'start', this.value)"></div>
                            <div class="col"><label>End Date</label><input type="date" value="${block.end}" oninput="updateBlock(${index}, 'end', this.value)"></div>
                         </div>`;
            }
            else if (block.type === 'countdown') {
                html += `<label>Event Name</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)">`;
                html += `<div class="row">
                            <div class="col"><label>Target Date</label><input type="date" value="${block.date}" oninput="updateBlock(${index}, 'date', this.value)"></div>
                            <div class="col"><label>Style</label>
                                <select onchange="updateBlock(${index}, 'style', this.value)">
                                    <option value="detailed" ${block.style=='detailed'?'selected':''}>Days + Hours</option>
                                    <option value="days" ${block.style=='days'?'selected':''}>Days Only</option>
                                </select>
                            </div>
                         </div>`;
            }
            else if (block.type === 'timer') {
                html += `<label>Timer Name (e.g., Focus Mode)</label>
                         <input type="text" value="${block.label || 'Timer'}" oninput="updateBlock(${index}, 'label', this.value)">`;
            }

            div.innerHTML = html;
            area.appendChild(div);
        });
    }

    // --- ACTIONS ---

    // 1. Add Block Logic
    window.addBlock = (type) => {
        let newBlock = { type: type };

        // Define defaults for each type so they don't crash
        if(type === 'header') newBlock.text = 'New Header';
        
        if(type === 'world_clock') newBlock.locations = [{label:'New York', timezone:'America/New_York'}];
        
        if(type === 'progress_group') newBlock.items = [{type:'month', label:'This Month'}, {type:'year', label:'This Year'}];
        
        if(type === 'progress_custom') {
            newBlock.label = 'New Project';
            newBlock.start = new Date().toISOString().split('T')[0]; // Today
            newBlock.end = '2025-12-31';
        }
        
        if(type === 'countdown') {
            newBlock.label = 'Big Event';
            newBlock.date = '2025-01-01';
            newBlock.style = 'detailed';
        }
        
        if(type === 'timer') {
            newBlock.label = 'Deep Work';
        }

        blocks.push(newBlock);
        renderBlocks();
        generateLink();
    };

    // 2. Remove Block
    window.removeBlock = (idx) => {
        blocks.splice(idx, 1);
        renderBlocks();
        generateLink();
    };

    // 3. Update Inputs
    window.updateBlock = (idx, key, val) => {
        blocks[idx][key] = val;
        generateLink();
    };
    
    window.updateBlockJSON = (idx, key, val) => {
        try {
            blocks[idx][key] = JSON.parse(val);
            generateLink();
        } catch(e) {
            // Ignore JSON errors while typing
        }
    };

    window.updateSettings = () => {
        settings.use24h = document.getElementById('set-time').value === '24';
        settings.theme = document.getElementById('set-theme').value;
        settings.fontSize = document.getElementById('set-font').value;
        generateLink();
    };

    // 4. Generate URL
    window.generateLink = () => {
        const fullConfig = { settings: settings, blocks: blocks };
        const jsonString = JSON.stringify(fullConfig);
        const encoded = btoa(jsonString); // Base64 Encode
        
        // Handle URL replacement
        let baseUrl = window.location.href;
        
        // If we are on admin.html, swap to index.html
        if(baseUrl.includes('admin.html')) {
            baseUrl = baseUrl.replace('admin.html', 'index.html');
        } else {
            // Fallback if URL structure is weird (e.g. root folder)
            baseUrl = baseUrl.split('?')[0].split('#')[0].replace(/\/$/, "") + '/index.html';
        }
        
        const finalUrl = `${baseUrl}#${encoded}`;
        document.getElementById('result-url').innerText = finalUrl;
        return finalUrl;
    };

    window.preview = () => {
        window.open(generateLink(), '_blank');
    };

    // Run on load
    init();

</script>

</body>
</html>
